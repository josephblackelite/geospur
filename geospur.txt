Perfect â€” this is exactly the right moment to freeze scope and feed Codex.

Below is a Codex-ready task definition that:

- locks the MVP
- avoids over-engineering
- minimizes Firebase/Cloud Function costs
- uses Node.js + Express + Firebase (Auth + Firestore)
- uses SvelteKit (web only)
- clearly answers one app vs two apps

---

# ğŸ”¹ FIRST: One App or Two?

## âœ… ONE APP. TWO MODES.

Do NOT build two separate apps.

### Why (important for MVP):

- One deploy
- One auth flow
- One codebase
- Faster iteration
- Easier trust + identity handling
- Businesses are often users too

### How it works:

- Same SvelteKit app
- Same Firebase project
- Same Auth
- User chooses (or is detected as):
  - Consumer mode
  - Business mode
- Role-based routing + UI

> This is exactly how Uber, Airbnb, Deliveroo started.

Codex instruction:

> Build a single SvelteKit web app with role-based UI (consumer / business).

---

# ğŸ”¹ CODEX TASK â€” GeoSpur MVP (Web)

Use this verbatim.

---

## CODEX TASK: Build GeoSpur MVP (Web, Firebase, Node.js)

### Goal

Build a fast, minimal MVP for GeoSpur:

- Real-time intent broadcast
- Business responses
- Accept + chat
- Trust (no-show)
- Progressive signup
- No ads
- Subscription-ready (not enforced yet)

We optimize for:

- speed
- simplicity
- minimal cloud functions
- low Firebase cost
- web-only MVP

---

## 1. TECH STACK (LOCKED)

### Frontend

- SvelteKit (web only)
- Simple pages, no animations framework
- Firebase Web SDK

### Backend

- Node.js + Express
- Single Express API
- Hosted on:
  - Firebase Hosting + Cloud Run OR
  - Any Node host (Express must be stateless)

### Firebase

- Firebase Auth (Phone OTP)
- Firestore (realtime)
- Firebase Cloud Messaging (required)

### Rules

- âŒ Avoid many Cloud Functions
- âŒ Avoid background triggers where possible
- âœ… Prefer API endpoints (Express)
- âœ… Firestore realtime listeners instead of WebSockets

---

## 2. APP STRUCTURE (ONE APP, TWO MODES)

### Auth

- Phone number OTP
- On first login:
  - user doc created
  - role = consumer by default

### Roles

- consumer
- business

Users can switch role only if they create a business profile.

---

## 3. CORE MVP FLOWS

---

### A. CONSUMER FLOW

#### 1. Landing (NO SIGNUP)

- Single input box:
  - â€œWhat do you need right now?â€
- Auto-detect location

#### 2. Draft Request

When user submits:

- Create request with:
  - status = draft
  - rawQuery
  - lat/lng
- Show â€œBroadcastingâ€¦â€ UI

#### 3. Progressive Signup Gate

- After ~1s:
  - Show phone OTP modal
- On verify:
  - Attach userId to request
  - status â†’ broadcasting
  - Call backend /route-request

#### 4. Live Offers

- Consumer listens to:
  requests/{id}/offers
- Show offers as they arrive

#### 5. Accept Offer

- User taps Accept
- Backend endpoint locks request
- Chat created

#### 6. Chat

- Simple text chat
- System messages included

#### 7. Completion

- User can:
  - Cancel (early)
  - Do nothing (business may mark no-show)

---

### B. BUSINESS FLOW

#### 1. Switch to Business Mode

- Consumer taps â€œBecome a businessâ€
- Creates business profile:
  - name
  - category (single)
  - location
  - radius
- role becomes business

#### 2. Online / Standby

- Toggle:
  - Online (waiting for intent)
  - Offline

#### 3. Intent Inbox

- Business listens to:
  requests/*/deliveries/{businessId}
- Shows incoming requests

#### 4. Respond

- Business sends one offer per request
- Offer fields:
  - message
  - optional price
  - optional ETA

#### 5. Chat + Accept

- If accepted:
  - Chat opens
  - Business expects user

#### 6. Closeout

- Buttons:
  - Mark Completed
  - Mark No-Show (guarded)

---

## 4. BACKEND (EXPRESS API ONLY)

### Required Endpoints

#### Auth

- Firebase handles OTP
- Backend verifies Firebase ID token

---

#### POST /route-request

Purpose: route intent to businesses

Input:

- requestId

Logic:

- Read request
- Resolve category (keyword rules)
- Find businesses:
  - category match
  - isOnline = true
  - within radius
- Create delivery docs:
  requests/{rid}/deliveries/{bid}

---

#### POST /respond-offer

- business sends offer
- validate:
  - business received delivery
  - request still open

---

#### POST /accept-offer

- transactional:
  - request.status = accepted
  - acceptedBusinessId set
  - chat created
- close other offers

---

#### POST /mark-no-show

- allowed only if:
  - request accepted
  - time threshold passed
- decrement user trust score

---

#### POST /mark-completed

- mark request completed
- increment trust score slightly

---

## 5. FIRESTORE DATA MODEL (MVP)

### users/{uid}

```js
{
  role: "consumer" | "business",
  phone,
  name,
  trustScore: 100,
  createdAt
}
```

### businesses/{bid}

```js
{
  ownerUid,
  name,
  category,
  lat,
  lng,
  radiusKm,
  isOnline,
  trialLeadsUsed: 0
}
```

### requests/{rid}

```js
{
  createdByUid,
  rawQuery,
  resolvedCategory,
  lat,
  lng,
  status: "draft" | "broadcasting" | "accepted" | "completed" | "no_show",
  acceptedBusinessId,
  createdAt
}
```

### requests/{rid}/deliveries/{bid}

```js
{
  deliveredAt
}
```

### requests/{rid}/offers/{oid}

```js
{
  businessId,
  message,
  price,
  eta,
  createdAt
}
```

### chats/{cid}

```js
{
  requestId,
  userId,
  businessId,
  createdAt
}
```

### chats/{cid}/messages/{mid}

```js
{
  senderType: "user" | "business" | "system",
  text,
  createdAt
}
```

---

## 6. TRUST / NO-SHOW RULES (MVP)

- Start trustScore = 100
- No-show: âˆ’25
- Late cancel: âˆ’10
- Completed: +2 (cap 100)

Enforcement:

- trust < 50 â†’ rate limit
- trust < 25 â†’ temporary block

---

## 7. WHAT WE EXPLICITLY DO NOT BUILD (MVP)

- âŒ Reviews
- âŒ Payments
- âŒ Inventory
- âŒ Ads
- âŒ Multiple categories per business
- âŒ Maps UI

---

## 8. MVP SUCCESS CRITERIA

- First response < 60s
- â‰¥ 3 offers per request
- Business response rate > 40%
- User completes action > 50%

---

## 9. CODING PRIORITY ORDER

1. Firebase Auth (OTP)
2. SvelteKit shell + role routing
3. Create request (draft)
4. Progressive signup
5. Backend routing
6. Business inbox
7. Offer response
8. Accept lock
9. Chat
10. No-show / trust

---

### END CODEX TASK

---

# ğŸ”¹ ADDENDUM TO CODEX TASK â€” Visual Context in Business Responses

## Critical Requirement: Business Responses Support Photos

### Why this is non-negotiable

GeoSpur is not just about availability â€” itâ€™s about vibe, trust, and confidence.

For many intents (nightlife, dining, venues, services):

- Text is not enough
- Users need instant visual context
- A single real photo can outperform 20 reviews

This is especially true in Dubai.

---

## What This Means for the MVP

### 1. Business Offer Responses MAY Include Media

When a business responds to a request, they can optionally attach:

- 1â€“3 photos
- Real photos (venue, table, space, setup, ambience)

This is optional per response, not mandatory.

---

### 2. Media Storage (Simple, Cheap)

- Use Firebase Storage
- Store photos under:

```
/offers/{requestId}/{businessId}/{photoId}.jpg
```

- Store only the download URLs in Firestore

No resizing pipeline for MVP.
No CDN tuning yet.
Keep it simple.

---

### 3. Firestore Offer Schema (UPDATED)

```js
requests/{rid}/offers/{oid}
{
  businessId,
  message,
  price,
  eta,
  photoUrls: [
    "https://firebasestorage.googleapis.com/..."
  ],
  createdAt
}
```

---

### 4. Frontend UX (Consumer Side)

When an offer arrives:

- Show photo thumbnail inline
- Tap opens full-screen preview
- Photos appear above text (visual-first)

This reinforces:

> â€œThis place is real, active, and inviting right now.â€

---

### 5. Frontend UX (Business Side)

In the Respond Sheet:

- Add button: Attach photo
- Allow:
  - Camera
  - Gallery
- Limit to max 3 photos per offer
- Compress client-side if possible (optional)

No album management.
No galleries.
Just quick context.

---

### 6. Guardrails (Important)

To prevent abuse:

- Photos only allowed after delivery (business was pinged)
- Photos only visible to the requesting user
- Photos tied to a specific request (not public)

No feed.
No browsing.
No reuse.

---

## Why This Strengthens GeoSpur (Strategically)

- Reduces decision anxiety
- Increases accept rate
- Makes responses feel alive
- Differentiates from Google/Yelp instantly
- Encourages businesses to compete on experience, not words

This is especially powerful for:

- Bars
- Lounges
- CafÃ©s
- Restaurants
- Salons
- Venues

---

## Final Instruction to Codex (Verbatim)

> Ensure business offer responses support optional photo attachments stored in Firebase Storage and rendered inline in the consumer offer feed. This is part of the MVP, not a later enhancement.

---

# âœ… FINAL DECISION (LOCKED)

- âœ… One app
- âœ… Client-side only
- âœ… Firebase handles realtime
- âœ… Express handles logic
- âŒ No SSR
- âŒ No SvelteKit server routes
- âŒ No static adapter tricks

---

# ğŸ§± CORE ARCHITECTURE (MINIMAL & SAFE)

### Frontend

- SvelteKit
- Client-side rendering ONLY
- export const ssr = false; everywhere
- No +page.server.ts
- No +layout.server.ts
- No SvelteKit API routes

### Backend

- Single Node.js + Express API
- Stateless
- Deployed on Cloud Run (or any Node host)
- All logic goes here

### Firebase

- Firebase Auth (Phone OTP)
- Firestore (realtime)
- Firebase Storage (offer photos)

> SvelteKit never talks directly to Firestore for writes that mutate state.
> It only reads realtime data + calls Express for actions.

---

# ğŸ“ REPO STRUCTURE (Codex must follow this)

```
geospur/
â”œâ”€ apps/
â”‚  â””â”€ web/
â”‚     â”œâ”€ src/
â”‚     â”‚  â”œâ”€ routes/
â”‚     â”‚  â”‚  â”œâ”€ +layout.ts
â”‚     â”‚  â”‚  â”œâ”€ +page.svelte          # consumer landing
â”‚     â”‚  â”‚  â”œâ”€ business/
â”‚     â”‚  â”‚  â”‚  â””â”€ +page.svelte       # business mode
â”‚     â”‚  â”‚  â”œâ”€ chat/
â”‚     â”‚  â”‚  â”‚  â””â”€ [id]/+page.svelte
â”‚     â”‚  â”œâ”€ lib/
â”‚     â”‚  â”‚  â”œâ”€ firebase.ts
â”‚     â”‚  â”‚  â”œâ”€ api.ts
â”‚     â”‚  â”‚  â”œâ”€ stores.ts
â”‚     â”‚  â”‚  â””â”€ auth.ts
â”‚     â””â”€ svelte.config.js
â”‚
â”œâ”€ services/
â”‚  â””â”€ api/
â”‚     â”œâ”€ src/
â”‚     â”‚  â”œâ”€ index.ts        # Express entry
â”‚     â”‚  â”œâ”€ auth.ts
â”‚     â”‚  â”œâ”€ routes.ts
â”‚     â”‚  â””â”€ firestore.ts
â”‚     â””â”€ package.json
â”‚
â””â”€ README.md
```

---

# ğŸ§  SVELTEKIT RULES (CRITICAL)

Codex MUST obey these rules:

```ts
// in +layout.ts
export const ssr = false;
export const prerender = false;
```

### âŒ NEVER DO:

- +page.server.ts
- +layout.server.ts
- SvelteKit endpoints
- static adapter
- prerender

### âœ… ALWAYS DO:

- Fetch via fetch() to Express API
- Listen to Firestore client-side
- Use Firebase SDK directly in browser

This guarantees no SSR / hydration / prod-only bugs.

---

# ğŸ” AUTH (FIREBASE ONLY)

- Phone OTP
- Client handles login
- Firebase ID token sent to Express in headers
- Express verifies token on protected routes

No auth logic in SvelteKit server.

---

# ğŸ§­ ONE APP, TWO MODES (LOCKED)

### Roles

- consumer
- business

### Switching

- User starts as consumer
- If user creates business profile â†’ role becomes business
- UI switches mode (route-based)

No separate apps.

---

# ğŸ” CORE FLOWS (FINAL)

## CONSUMER

1. User lands â†’ types query (no signup)
2. Create draft request in Firestore
3. Show â€œbroadcastingâ€¦â€ animation
4. Prompt OTP
5. After OTP:
   - attach userId
   - status â†’ broadcasting
   - call POST /route-request
6. Listen to offers realtime
7. Accept offer â†’ API call
8. Chat opens
9. Business marks complete / no-show

---

## BUSINESS

1. Login
2. Create business profile
3. Toggle Online
4. Listen to deliveries realtime
5. Respond with:
   - text
   - optional price
   - optional ETA
   - optional photos
6. If accepted â†’ chat
7. Mark complete / no-show

---

# ğŸ–¼ï¸ PHOTO SUPPORT (MVP-CRITICAL)

- Businesses can attach 1â€“3 photos per offer
- Stored in Firebase Storage
- URLs saved in Firestore
- Only visible to requesting user

No galleries, no feeds, no reuse.

---

# ğŸ”Œ EXPRESS API (ONLY LOGIC LAYER)

### Endpoints

```
POST /route-request
POST /register-push-token
POST /respond-offer
POST /accept-offer
POST /mark-completed
POST /mark-no-show
```

All endpoints:

- verify Firebase ID token
- run Firestore transactions
- no background triggers
- no cron
- no listeners

---

# ğŸ”” PUSH NOTIFICATIONS (MVP-CRITICAL)

Push is REQUIRED for:

- New intent delivered to business
- Offer accepted
- New chat message
- Cancellation / no-show

Implementation rules (LOCKED):

- Push sent only from Express
- No Firestore triggers
- No cron
- No retries loop
- Push = wake-up signal only
- UI state always read from Firestore

FCM token handling:

- Client registers token after login
- Token sent to backend via API (POST /register-push-token)
- Tokens stored on:
  - users/{uid}.fcmTokens[]
  - businesses/{bid}.fcmTokens[]

---

# ğŸ“¦ FIRESTORE (REALTIME ONLY)

Firestore is used for:

- request state
- deliveries
- offers
- chat
- trust score

Express mutates.
Clients listen.

This keeps costs predictable and low.

---

# ğŸ§® TRUST SYSTEM (LOCKED)

- Start: 100
- No-show: âˆ’25
- Late cancel: âˆ’10
- Completed: +2 (cap 100)

Enforcement:

- <50 â†’ throttle
- <25 â†’ block

---

# âŒ EXPLICITLY OUT OF SCOPE

- SSR
- Static builds
- Payments
- Reviews
- Inventory
- Maps UI
- Background Cloud Functions

---

# ğŸ¯ MVP SUCCESS DEFINITION

If these are true, MVP is a success:

- First response < 60s
- â‰¥ 3 offers per request
- Business response rate > 40%
- User completes action > 50%

---

# ğŸ§  FINAL CODEX INSTRUCTION (COPY THIS)

> Build GeoSpur as a client-only SvelteKit app with no SSR, backed by a single Express API, using Firebase Auth, Firestore realtime listeners, and Firebase Storage.
>
> Avoid SvelteKit server routes, background Cloud Functions, and static adapters.
>
> Prioritize correctness, realtime flow, and minimal infrastructure over abstraction.

---

## Final reassurance (important)

This setup:

- Will not break in production
- Will not have SSR vs local mismatches
- Will not suffer from static adapter issues
- Will not balloon Firebase costs
- Is easy to refactor later

This is the right MVP architecture.
